import requests
import folium
import webbrowser
import os

def obtenir_mon_ip():
    # Utilise une API simple pour obtenir l'IP publique actuelle
    try:
        return requests.get('https://api.ipify.org').text
    except:
        return None

def generer_carte_interactive():
    # 1. Détection de l'IP
    ip_cible = input("Entrez une IP (ou appuyez sur Entrée pour la vôtre) : ")
    if not ip_cible:
        ip_cible = obtenir_mon_ip()
    
    print(f"Analyse de l'IP : {ip_cible}...")

    # 2. Récupération des données de géolocalisation
    url = f"http://ip-api.com/json/{ip_cible}"
    data = requests.get(url).json()

    if data.get('status') == 'success':
        lat, lon = data['lat'], data['lon']
        ville = data.get('city', 'Inconnue')
        
        # 3. Création de la carte
        carte = folium.Map(location=[lat, lon], zoom_start=12)
        
        # Ajout d'un cercle pour montrer la zone d'incertitude
        folium.Circle(
            radius=2000, # Rayon de 2km car l'IP n'est pas précise à 100%
            location=[lat, lon],
            color="crimson",
            fill=True,
        ).add_to(carte)

        folium.Marker(
            [lat, lon], 
            popup=f"IP: {ip_cible}\nVille: {ville}",
            icon=folium.Icon(color='blue', icon='home')
        ).add_to(carte)

        # 4. Sauvegarde et ouverture automatique
        nom_fichier = "ma_localisation.html"
        carte.save(nom_fichier)
        
        print(f"Carte générée : {nom_fichier}")
        # Ouvre automatiquement le navigateur
        webbrowser.open('file://' + os.path.realpath(nom_fichier))
    else:
        print("Erreur : Impossible de récupérer les données.")

if __name__ == "__main__":
    generer_carte_interactive()

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Moto-Taxi : Police Pursuit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        body { margin: 0; font-family: 'Courier New', monospace; overflow: hidden; background: #000; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        #ui {
            position: fixed; top: 10px; left: 10px; right: 10px; z-index: 1000;
            display: flex; justify-content: space-between; pointer-events: none;
        }
        .gauge {
            background: rgba(20, 20, 20, 0.9); color: #ff0055; padding: 10px;
            border-radius: 4px; border: 1px solid #ff0055; text-align: center;
        }
        #fuel-bar { width: 100px; height: 10px; background: #300; margin-top: 5px; }
        #fuel-inner { width: 100%; height: 100%; background: #ff0055; }
        #controls {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: grid; grid-template-columns: repeat(3, 70px); grid-gap: 10px; z-index: 1000;
        }
        .btn {
            width: 70px; height: 70px; background: rgba(0,0,0,0.6);
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            font-size: 30px; color: white; pointer-events: auto; border: 1px solid #ff0055;
        }
        .btn:active { background: #ff0055; }
    </style>
</head>
<body>

<div id="ui">
    <div class="gauge">üìç <span id="city-name">-</span></div>
    <div class="gauge">‚õΩ FUEL<div id="fuel-bar"><div id="fuel-inner"></div></div></div>
    <div class="gauge">üì¶ <span id="score">0/3</span></div>
</div>

<div id="map"></div>

<div id="controls">
    <div></div><div class="btn" onmousedown="startMove('up')" ontouchstart="startMove('up')">‚ñ≤</div><div></div>
    <div class="btn" onmousedown="startMove('left')" ontouchstart="startMove('left')">‚óÄ</div>
    <div class="btn" onmousedown="startMove('down')" ontouchstart="startMove('down')">‚ñº</div>
    <div class="btn" onmousedown="startMove('right')" ontouchstart="startMove('right')">‚ñ∂</div>
</div>

<script>
    const levels = [
        { name: "PARIS", center: [48.8566, 2.3522], missions: [[48.858, 2.352], [48.854, 2.345], [48.861, 2.337]], cops: 1 },
        { name: "DAKAR", center: [14.7167, -17.4677], missions: [[14.724, -17.484], [14.706, -17.447], [14.735, -17.455]], cops: 2 },
        { name: "NEW YORK", center: [40.7128, -74.0060], missions: [[40.715, -74.009], [40.710, -74.001], [40.718, -74.003]], cops: 3 }
    ];

    let currentLevel = 0, score = 0, fuel = 100, gameActive = true;
    let motoPos, moveInterval, markers = [], cops = [];

    const map = L.map('map', { zoomControl: false, attributionControl: false });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    const motoMarker = L.marker([0,0], {
        icon: L.divIcon({ html: '<i class="fa-solid fa-motorcycle fa-2x" style="color:#fff"></i>', className:'m'})
    }).addTo(map);

    function initLevel(idx) {
        const lvl = levels[idx];
        motoPos = { lat: lvl.center[0], lng: lvl.center[1] };
        map.setView(lvl.center, 16);
        
        // Nettoyage
        markers.forEach(m => m.remove());
        cops.forEach(c => c.marker.remove());
        markers = []; cops = []; score = 0; fuel = 100;

        document.getElementById('city-name').innerText = lvl.name;
        document.getElementById('score').innerText = "0/3";

        // Ajout Clients
        lvl.missions.forEach(pos => {
            markers.push({pos, done: false, obj: L.circle(pos, {radius: 40, color: 'gold'}).addTo(map)});
        });

        // Ajout Police
        for(let i=0; i<lvl.cops; i++) {
            let p = { lat: lvl.center[0]+0.002, lng: lvl.center[1]+0.002 };
            let m = L.marker([p.lat, p.lng], {
                icon: L.divIcon({ html: '<i class="fa-solid fa-thumbtack fa-spin" style="color:red"></i> üöì', className:'c'})
            }).addTo(map);
            cops.push({pos: p, marker: m, dir: Math.random() * Math.PI * 2});
        }
    }

    function startMove(dir) {
        if(moveInterval) clearInterval(moveInterval);
        moveInterval = setInterval(() => {
            let step = 0.0005;
            if(dir=='up') motoPos.lat += step; if(dir=='down') motoPos.lat -= step;
            if(dir=='left') motoPos.lng -= step; if(dir=='right') motoPos.lng += step;
            
            fuel -= 0.3;
            motoMarker.setLatLng([motoPos.lat, motoPos.lng]);
            map.panTo([motoPos.lat, motoPos.lng], {animate: false});
            updateGame();
        }, 40);
    }

    document.addEventListener('mouseup', () => clearInterval(moveInterval));
    document.addEventListener('touchend', () => clearInterval(moveInterval));

    function updateGame() {
        document.getElementById('fuel-inner').style.width = fuel + "%";
        if(fuel <= 0) { alert("POLICE OU PANNE !"); initLevel(currentLevel); return; }

        // Bouger la police
        cops.forEach(c => {
            c.pos.lat += Math.sin(c.dir) * 0.0003;
            c.pos.lng += Math.cos(c.dir) * 0.0003;
            c.marker.setLatLng([c.pos.lat, c.pos.lng]);
            if(Math.random() > 0.95) c.dir = Math.random() * Math.PI * 2;
            
            // Collision Police
            if(map.distance([motoPos.lat, motoPos.lng], [c.pos.lat, c.pos.lng]) < 40) fuel = 0;
        });

        // Collision Bagages
        markers.forEach(m => {
            if(!m.done && map.distance([motoPos.lat, motoPos.lng], m.pos) < 50) {
                m.done = true; m.obj.remove(); score++;
                fuel = Math.min(100, fuel + 35);
                document.getElementById('score').innerText = score + "/3";
                if(score == 3) {
                    currentLevel = (currentLevel + 1) % levels.length;
                    alert("NIVEAU R√âUSSI ! Prochaine ville...");
                    initLevel(currentLevel);
                }
            }
        });
    }

    initLevel(0);
</script>
</body>
</html>
